[tasks."install:dotfiles"]
description = "Create symlinks for dotfiles to home directory"
run = '''
#!/bin/bash
set -e

IGNORE_FILES=".git README.md mise.toml bin nvim ghostty"
BASE_PATH="{{config_root}}"

for file in "$BASE_PATH"/{.*,*}; do
  filename=$(basename "$file")

  # Skip ignored files
  [[ " $IGNORE_FILES " =~ " $filename " ]] && continue
  [[ "$filename" == "." || "$filename" == ".." ]] && continue

  dest="$HOME/$filename"
  ln -sfn "$file" "$dest"
  echo "Linked: $filename -> $dest"
done
'''

[tasks.deno-scripts]
description = "Install deno scripts"
depends = ["install:deno"]
run = '''
#!/bin/bash
set -e
deno install --global --allow-run -n git-modified_files https://deno.land/x/git_modified_files@0.1.4/main.ts
'''

[tasks."install:deno"]
description = "Install deno via mise"
run = "mise install deno"

[tasks."install:ghostty"]
description = "Create ~/.config/ghostty symlink"
run = '''
#!/bin/bash
set -e
mkdir -p "$HOME/.config"
ln -sfn "{{config_root}}/ghostty" "$HOME/.config/ghostty"
echo "Linked: ghostty -> $HOME/.config/ghostty"
'''

[tasks."install:nvim"]
description = "Install neovim via mise and create ~/.config/nvim symlink"
run = '''
#!/bin/bash
set -e
mise install neovim
mkdir -p "$HOME/.config"
ln -sfn "{{config_root}}/nvim" "$HOME/.config/nvim"
echo "Linked: nvim -> $HOME/.config/nvim"
'''

[tasks.setup]
description = "Run all setup tasks (dotfiles, nvim, ghostty, deno)"
depends = ["install:dotfiles", "install:nvim", "install:ghostty", "deno-scripts"]

[tasks.cleanup]
description = "Remove symlinks in home that point to this repo but whose targets no longer exist"
run = '''
#!/bin/bash
set -e

BASE_PATH="{{config_root}}"
removed=0

for link in "$HOME"/{.*,*}; do
  [[ -L "$link" ]] || continue
  target=$(readlink "$link")
  [[ "$target" == "$BASE_PATH"* ]] || continue

  if [[ ! -e "$link" ]]; then
    echo "Removing orphaned symlink: $(basename "$link") -> $target"
    rm "$link"
    ((removed++))
  fi
done

echo "Done. Removed $removed orphaned symlink(s)."
'''

